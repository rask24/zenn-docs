---
title: "fish + nvm ç’°å¢ƒã§cdæ™‚ã«è‡ªå‹•ã§nvm useã™ã‚‹æ–¹æ³•"
emoji: "ğŸ˜¶â€ğŸŒ«ï¸"
type: "tech"
topics: ["macOS", "Node.js", "nvm", "fish", "fisher"]
published: false
---

## ç›®æ¨™
fishã§nvmã‚’ä½¿ã†éš›ã«ã€ç§»å‹•ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.nvmrcãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°è‡ªå‹•ã§`nvm use`ã‚’å®Ÿè¡Œã—ã€nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

## ç’°å¢ƒ
- MacBook Pro M1, 2020
- macOS 14.3(Sonoma)
- fish 3.7.0
- fisher 4.4.4
- nvm.fish  2.2.13

## fishã®nvmå°å…¥æ–¹æ³•
brewã§fishã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ã§ã‚ã‚‹[fisher](https://github.com/jorgebucaran/fisher)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```shell
brew install fisher
```
fisherã‚’ä½¿ã£ã¦fishç‰ˆã®nvm([nvm.fish](https://github.com/jorgebucaran/fisher))ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```shell
fisher install jorgebucaran/nvm.fish
```

## cdæ™‚ã«nvm useã‚’è¡Œã†è¨­å®šæ–¹æ³•
[ã“ã®ãƒšãƒ¼ã‚¸](https://gist.github.com/eugenet8k/535bf3c51d1fc7c31cb8784e55d4dae4)ã‚’å‚è€ƒã«ã—ã¦fishã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã€‚

```shell:~/.config/fish/funcitons/__check_nvm.fish

function __check_nvm --on-variable PWD --description 'Do nvm stuff' # --on-variable PWD: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç§»å‹•ã—ãŸã‚‰å®Ÿè¡Œã™ã‚‹
  if test -f .nvmrc # .nvmrcãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    set node_version (node -v) # ç¾åœ¨ã®nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
    set node_version_target (cat .nvmrc) # .nvmrcã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    set nvmrc_node_version (nvm list | grep $node_version_target) # .nvmrcãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è‡´ã•ã›ã‚‹

    if not string match -q -- "*$node_version*" $nvmrc_node_version
      nvm use $node_version_target # ç¾åœ¨ã®nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨.nvmrcã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚Œã°nvm useã‚’å®Ÿè¡Œã™ã‚‹
    end
  end
end

__check_nvm # å¸¸ã«å®Ÿè¡Œã•ã›ã‚‹
```

config.fishã§é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ã†ã€‚
```shell:~/.config/fish/config.fish
# NVM Function Source
source ~/.config/fish/functions/__check_nvm.fish
```

## æ¤œè¨¼
ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ã€‚ç¾åœ¨ã¯brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸsystemæ¨™æº–ã®nodeã‚’å‚ç…§ã—ã¦ã„ã‚‹ã€‚
```shell
â¯ nvm list
 â–¶   system
   v18.19.0 lts/hydrogen
   v20.11.0 lts/iron
    v21.6.1 latest
```
testãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦test/.nvmrcå†…ã«18(node v18)ã‚’è¨˜è¼‰ã™ã‚‹ã€‚
```shell
mkdir test && echo 18 > test/.nvmrc
```
cdã™ã‚‹
```shell
â¯ cd test
Now using Node v18.19.0 (npm 10.2.3) ~/.local/share/nvm/v18.19.0/bin/node
```
ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹
```shell
â¯ node -v
v18.19.0
```
æœŸå¾…é€šã‚Šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã§ããŸã€‚
nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ.nvmrcã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ã—ã¦ã„ã‚Œã°æ¬¡å›ä»¥é™ã®cdã§nvm useã¯å®Ÿè¡Œã•ã‚Œãªã„
```shell
â¯ cd .. && cd test
# nvm useã¯å®Ÿè¡Œã•ã‚Œãªã„
```
zã‚³ãƒãƒ³ãƒ‰ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹(PWDãŒå¤‰æ›´ã•ã‚Œã‚‹ã®ã§å½“ç„¶ã¨è¨€ãˆã°å½“ç„¶)
```shell
â¯ cd

â¯ nvm use system
Now using Node v21.6.1 (npm 10.2.4) /opt/homebrew/Cellar/node/21.6.1/bin/node

â¯ z test
Now using Node v18.19.0 (npm 10.2.3) ~/.local/share/nvm/v18.19.0/bin/node
```

### åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¤‡æ•°ã‚ã‚‹å ´åˆ
grepã™ã‚‹ç®‡æ‰€ã§2è¡Œä»¥ä¸Šå‡ºåŠ›ã•ã‚Œã‚‹å ´åˆã§ã‚‚æœŸå¾…é€šã‚Šå‹•ä½œã™ã‚‹ã€‚
ä»¥ä¸‹ã®å ´åˆã‚’è€ƒãˆã‚‹ã€‚
```shell
â¯ nvm list
 â–¶   system
   v18.18.2 lts/hydrogen
   v18.19.0 lts/hydrogen
   v20.11.0 lts/iron
    v21.6.1 latest
```
å¤‰æ•°ã‚’ç¢ºèªã™ã‚‹ã€‚
```shell
â¯ printf "%s\n" $node_version $node_version_target $nvmrc_node_version
v21.6.1
18
   v18.18.2 lts/hydrogen
   v18.19.0 lts/hydrogen
```
æ¤œè¨¼ã™ã‚‹ã€‚
```shell
â¯ not string match -q -- "*$node_version*" $nvmrc_node_version
# æ–‡å­—åˆ—"v18.18.2 lts/hydrogen\nv18.19.0 lts/hydrogen"ãŒ"v21.6.1"ãŒéƒ¨åˆ†æ–‡å­—åˆ—ã‚’å«ã¾ãªã„ã‹ã©ã†ã‹
â¯ echo $status
0
# ãªã„ã®ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹0ãŒè¿”ã‚‹
```
ä¸Šè¨˜ã«ã‚ˆã£ã¦ifæ–‡å†…ã®nvm use 18`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
**è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã£ã¦ã‚‚æ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒã‚’è¡Œã†ã®ã§ãƒ­ã‚¸ãƒƒã‚¯ã«ä¸éƒ½åˆã¯ãªã„ã€‚**

v18.18.2ã®çŠ¶æ…‹ã§.nvmrcã«18.19ã‚’æ›¸ã„ã¦ã‚‚ã—ã£ã‹ã‚Šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¤‰æ›ãŒè¡Œã‚ã‚Œã‚‹ã€‚(ã“ã®å ´åˆã¯grepã®æ®µéšã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒçµã‚‰ã‚Œã‚‹ã€‚)

## å•é¡Œç‚¹
### iTermã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã¨æœŸå¾…é€šã‚Šå‹•ããŒã€VSCodeã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã ã¨æœŸå¾…é€šã‚Šå‹•ã‹ãªã„
```shell
â¯ mkdir test && echo 18 > test/.nvmrc

â¯ cd test
Now using Node v21.6.1 (npm 10.2.4) /opt/homebrew/Cellar/node/21.6.1/bin/node
```
test/.nvmrcã«ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³18ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãŒã€cdã—ãŸå¾Œã®nodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯systemæ¨™æº–ã®21ã«ãªã£ã¦ã„ã‚‹ã€‚
ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ã¿ã‚‹
```shell
â¯ which -a node
/opt/homebrew/bin/node
/Users/reiyaasuke/.local/share/nvm/v18.19.0/bin/node
```
ãƒ‘ã‚¹ã®é †ç•ªãŒæœŸå¾…ã—ã¦ã„ã‚‹é †ç•ªã¨é€†ã«ãªã£ã¦ã„ã‚‹ã€‚æœ¬æ¥ã¯nvmã®ãƒ‘ã‚¹ãŒhomebrewã®ãƒ‘ã‚¹ã‚ˆã‚Šä¸Šã«ãã‚‹ã¯ãšã§ã‚ã‚‹ãŒã€ãªãœã‹ä¸Šæ‰‹ãã„ã‹ãªã„ã€‚

#### è§£æ±ºæ³•
ãƒ‘ã‚¹ã®é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‹é–¢æ•°ã‚’æ›¸ãæ‰‹ã‚‚ã‚ã‚‹ãŒã€nvm.fishè‡ªä½“ãŒãã®å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã‚‹ã¯ãšãªã®ã§ç«¶åˆã‚’æã‚Œã¦ã“ã®æ–¹æ³•ã¯å›é¿ã€‚
ã©ã†ã‚„ã‚‰ã“ã®ç¾è±¡ã¯**v18å›ºæœ‰ã®ç¾è±¡**ã§v20ã ã¨ä¸Šæ‰‹ãå‹•ãã€‚
v20ã‚’æŒ‡å®šã—ã¦ã‹ã‚‰nvm useã™ã‚‹ã¨ãƒ‘ã‚¹ãŒæœŸå¾…é€šã‚Šã«å¤‰æ›´ã•ã‚Œã‚‹ã€‚

```shell:~/.config/fish/funcitons/__check_nvm.fish
function __check_nvm --on-variable PWD --description 'Do nvm stuff'
  if test -f .nvmrc
    set node_version (node -v)
    set node_version_target (cat .nvmrc)
    set nvmrc_node_version (nvm list | grep $node_version_target)

    if not string match -q -- "*$node_version*" $nvmrc_node_version
      nvm --silent use 20 # ä¸€åº¦v20ã«ã™ã‚‹ --silentã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å‡ºåŠ›ã‚’ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
      nvm use $node_version_target
    end
  end
end

__check_nvm
```
